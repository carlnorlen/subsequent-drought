#ANOVA and Tukey HSD for basal area die-off by sequence and time period
aov.dead <- aov(data = join.summary %>% filter(pltID %in% plots), #group_by(time.period, sequence, pltID) %>%
# summarize(BAA.all = sum(BAA.all), BAA.live = sum(BAA),
#           BAA.dead.sum = sum(BAA.dead),
#           BAA.mort = sum(BAA.dead) / sum(BAA.all) * 100),
BAA.dead.sum ~ time.period * sequence)
summary(aov.dead)
#Tukey HSD
dead.tHSD <- TukeyHSD(aov.dead)
dead.tHSD
#ANOVA and Tukey HSD for basal are die-off by forest type, sequence, ane time period
type.aov.dead <- aov(data = all.forest.type %>% filter(pltID %in% plots & tree_type %in% c('pine', 'oak', 'fir', 'juniper', 'cedar')), BAA.dead.sum ~ time.period * sequence * tree_type)
summary(type.aov.dead)
type.dead.tHSD <- TukeyHSD(type.aov.dead)
type.dead.tHSD
#Create labels for the bar chart (a)
p3_texta <- data.frame(label = c("a", "a", "b", "b"),
sequence   = c('Both Droughts', 'Both Droughts', '2nd Drought Only', '2nd Drought Only'),
# tree_type = c('pine/fir', 'other tree', 'pine/fir', 'other tree',
#               'pine/fir', 'other tree', 'pine/fir', 'other tree'),
y     = c(29, 21, 37.5, 37),
x     = c(1, 2, 1, 2)
)
#Letters to indicate sample sizes
p3_textb <- data.frame(label = c("n = 58", "n = 39", "n = 259", "n = 241"),
sequence   = c('Both Droughts', 'Both Droughts', '2nd Drought Only', '2nd Drought Only'),
y     = c(26, 18, 34.5, 34),
x     = c(1, 2, 1, 2)
)
#Summary of Total Basal Area
p3 <- ggbarplot(all.forest %>% filter(pltID %in% plots) %>% group_by(time.period, sequence, pltID) %>% summarize(BAA.all.sum = sum(BAA.all), BAA.live = sum(BAA), BAA.dead.sum = sum(BAA.dead), BAA.mort = sum(BAA.dead) / sum(BAA.all) * 100), #%>% filter(COMMON_NAME %in% sp.both.2002[! sp.both.2002 %in% c('curlleaf mountain-mahogany', 'California live oak')]), #, (sequence == 'Both Droughts' & drought == '1999-2002') | (sequence == '2012-2015 Only' & drought == '2012-2015')),
x = "time.period", y = "BAA.all.sum", position = position_dodge(), color = "sequence", fill = 'gray',
add = "mean_se" , error.plot = "errorbar", alpha = 0.8, ylab = expression('Basal Area (m'^2*' ha'^-1*')')) +
theme_bw() + guides(color = 'none', fill = 'none') +
scale_color_manual(values = c("black", "black"), aesthetics = "color") + labs(tag = 'b)') +
theme(legend.background = element_rect(colour = NA, fill = NA), legend.justification = c(1, 0),
legend.position = c(0.76, 0.15), legend.text = element_text(size = 6, angle = 45), legend.title = element_text(size = 8),
legend.direction = "vertical", axis.text.x = element_blank(), axis.title.x = element_blank(),
axis.text.y = element_text(size = 8), axis.title.y = element_text(size = 10), plot.margin = unit(c(2.5,0,0,5), "pt"),
panel.spacing = unit(20, "pt"), plot.tag.position = c(0.54, 0.96), plot.tag = element_text(face = "bold"),
strip.text.x = element_text(size = 10, face = 'bold')) +
geom_text(data = p3_texta, mapping = aes(x = x, y = y, label = label), size = 5) +
geom_text(data = p3_textb, mapping = aes(x = x, y = y, label = label), size = 3) +
geom_text(data = data.frame(label = "Mean \n+/- SE", y = 21.2, x = 1.2, sequence = 'Both Droughts'), mapping = aes(x=x, y=y, label = label), size = 2) +
facet_grid(~ factor(sequence, levels = c('Both Droughts', '2nd Drought Only')),
labeller = as_labeller(c('Both Droughts' = "Exposed to Both Droughts", '2nd Drought Only' = "Exposed to 2nd Drought Only")))
p3
#Create a data frame for adding the panel 4 text.
p4_texta <- data.frame(label = c("ad", "ab", "ab", "b", "b", "ad", "ab", "ab", "ab", "b",
"c", "d", "b", "b", "b", "c", "d", "b", "b", "b"),
sequence   = c('Both Droughts', 'Both Droughts', 'Both Droughts', 'Both Droughts', 'Both Droughts', 'Both Droughts',
'Both Droughts', 'Both Droughts', 'Both Droughts', 'Both Droughts', '2nd Drought Only', '2nd Drought Only',
'2nd Drought Only', '2nd Drought Only', '2nd Drought Only', '2nd Drought Only', '2nd Drought Only', '2nd Drought Only',
'2nd Drought Only', '2nd Drought Only'),
# tree_type = c('pine/fir', 'other tree', 'pine/fir', 'other tree',
#               'pine/fir', 'other tree', 'pine/fir', 'other tree'),
y     = c(11.3, 6.3, 7.55, 3.75, 2.25, 8.7, 3.8, 5.3, 5.2, 1.5,
17, 12.1, 3.3, 2.8, 3.5, 19, 11.2, 3.7, 2.25, 3.8),
x     = c(0.615, 0.81, 1.01, 1.2, 1.38, 1.615, 1.81, 2.01, 2.2, 2.38,
0.615, 0.81, 1.01, 1.2, 1.38, 1.615, 1.81, 2.01, 2.2, 2.38)
)
#Total Basal Area
p4 <- ggbarplot(all.forest.type %>% filter(pltID %in% plots & tree_type != 'other conifer' & tree_type != 'deciduous'),
x = "time.period", y = "BAA.all.sum", position = position_dodge(), fill = 'tree_type.f', color = "sequence",
add = "mean_se" , error.plot = "errorbar", alpha = 0.8, ylab = expression('Basal Area (m'^2*' ha'^-1*')'),
xlab = NULL, order = c('1999-2002', '2012-2015')) +
theme_bw() + guides(color = 'none', fill = guide_legend(title = "Tree Type",  label.position = "bottom", title.position="top", title.hjust = 0.5)) +
scale_color_manual(values = c("black", "black"), aesthetics = "color") + labs(tag =("d)")) +
scale_fill_discrete(labels = c("pine" = "Pine", "fir" = "Fir", "juniper" = "Juniper", "oak" = "Oak", "cedar" = "Cedar")) +
theme(legend.background = element_rect(colour = NA, fill = NA),
legend.position = c(0.3, 0.75), legend.text = element_text(size = 6, angle = 45, vjust = 0.8), legend.title = element_text(size = 8),
legend.direction = "horizontal",axis.text.x = element_text(size = 10, color = 'black'), axis.title.x = element_blank(),
axis.text.y = element_text(size = 8), axis.title.y = element_text(size = 10),
strip.background = element_blank(), strip.text.x = element_blank(), plot.margin = unit(c(2.5,0,0,5), "pt"),
panel.spacing = unit(20, "pt"), plot.tag.position = c(0.54, 0.96), plot.tag = element_text(face = "bold")) +
scale_x_discrete(labels = c("Mortality During\n1st Period", "Mortality During\n2nd Period")) +
geom_text(data = p4_texta, mapping = aes(x = x, y = y, label = label), size = 5) +
facet_grid(~ factor(sequence, levels = c('Both Droughts', '2nd Drought Only')))
p4
f2 <- ggarrange(p3, p4, ncol = 1, labels = c('a)', 'c)'), align = "v", nrow = 2, heights = c(1, 0.95), common.legend = FALSE)
f2
ggsave(filename = 'SFig6_basal_area_boxplot.png', height=14, width=16, units = 'cm', dpi=900)
p1 <- ggplot(subset(all.ca.spi48, count >= 20), mapping = aes(x = spi48_09_2002, y = spi48_09_2015, fill = dNDMI_2004.mean, group = dNDMI_2004.mean)) +
geom_bin2d(mapping = aes(group = dNDMI_2004.mean), binwidth = c(0.1, 0.1)) + theme_bw() +
ylim(-3.5, 0) + xlim(-3, 2) +
ylab(expression(atop(NA,atop(textstyle("Severity of 2nd Drought"), textstyle("(SPI48 2012-2015)"))))) +  xlab('Severity of 1st Drought\n(SPI48 1999-2002)') +
# geom_vline(xintercept = 0, size = 0.25) +
# geom_hline(yintercept = 0, size = 0.25) +
geom_vline(xintercept = -1.5, size = 0.5, color = 'black', linetype='dashed') +
geom_hline(yintercept = -1.5, size = 0.5, color = 'black', linetype='dashed') +
guides(fill = guide_colorbar(barwidth = 5, barheight = 1, title.position = "top", title.hjust = 0.5, ticks.colour = "black", reverse = T), alpha = "none") +
theme(axis.text.x = element_text(size = 8), axis.text.y = element_text(size = 8), axis.title.x = element_text(size = 10),
axis.title.y = element_text(size = 10), plot.title = element_text(size = 10, hjust = 0.5), legend.background = element_rect(colour = NA, fill = NA),
legend.justification = c(1, 0), legend.position = c(0.895, 0.67), legend.text = element_text(size = 6),
legend.title = element_text(size = 8), legend.direction = "horizontal", strip.text = element_text(size = 10, face = 'bold'),
plot.margin = unit(c(0,0,0,0), "pt")) +
scale_fill_gradient2(name = "Die-off (dNDMI)", limits = c(-0.16, 0.07), midpoint = 0, low = "#D41159", mid = "lightyellow1", high = "#1A85FF") +
facet_wrap(~ both) +
annotate(geom="text", x=-1.15, y=-0.5, label="Less\nDie-off", color="black", size = 2) +
annotate(geom="text", x=1.9, y=-0.5, label="More\nDie-off", color="black", size = 2) +
annotate(geom="text", x = -2.9, y = -3.5, label="bold(Drier)", size = 2, parse = TRUE) +
annotate(geom="text", x = 1.75, y = -3.5, label ="bold(Wetter)", size = 2, parse = TRUE)
#Plot dNDMI 2017 with SPI48 2002 by SPI48 2015 grid
p2 <-ggplot(subset(all.ca.spi48, count >= 20), mapping = aes(x = spi48_09_2002, y = spi48_09_2015, fill = dNDMI_2017.mean, group = dNDMI_2017.mean)) +
geom_bin2d(mapping = aes(group = dNDMI_2017.mean), binwidth = c(0.1, 0.1)) + theme_bw() +
ylim(-3.5, 0) + xlim(-3, 2) +
ylab(NULL) +  xlab('Severity of 1st Drought\n(SPI48 1999-2002)') +
# geom_vline(xintercept = 0, size = 0.25) +
# geom_hline(yintercept = 0, size = 0.25) +
geom_vline(xintercept = -1.5, size = 0.5, color = 'black', linetype='dashed') +
geom_hline(yintercept = -1.5, size = 0.5, color = 'black', linetype='dashed') +
guides(fill = "none", alpha = "none") +
theme(axis.text.x = element_text(size = 8), axis.text.y = element_blank(), axis.title.x = element_text(size = 10),
axis.title.y = element_blank(), strip.text = element_text(size = 10, face = 'bold'), plot.margin = unit(c(0,0,0,20), "pt")) +
scale_fill_gradient2(name = "Die-off (dNDMI)", limits = c(-0.16, 0.07), midpoint = 0, low = "#D41159", mid = "lightyellow1", high = "#1A85FF") +
annotate("text", x = -0.25, y = -0.75, label = "Neither \nDrought", size = 3) + annotate("text", x = -2.4, y = -0.5, label = "1st Drought \nOnly", size = 3) +
annotate("text", x = -2.4, y = -3, label = "Both \nDroughts", size = 3) + annotate("text", x = 1, y = -2, label = "2nd Drought \nOnly", size = 3) +
facet_wrap( ~ second)
#Combine the two figure panels into one
f1 <- ggarrange(p1, p2, ncol = 2, nrow = 1, widths = c(1, 0.9), labels = c('a)', 'b)'), align = 'h', common.legend = FALSE)
f1
#Save the figure as a png
ggsave(filename = 'Fig3_spi48_dNDMI_SPI48_grid_scatter.png', device = 'png', height=7, width=15, units = 'cm', dpi=900)
p <- c('dplyr','tidyr','ggplot2','ggpubr','segmented', 'patchwork','RColorBrewer','gt', 'gtsummary',
'webshot', 'kableExtra', 'broom', 'ggpmisc', 'relaimpo', 'mlr', 'caret', 'stats', 'purrr',
'nlme')
#Install a package
# install.packages("glmmfields")
# library('nlme')
#Load packages
lapply(p,require,character.only=TRUE)
#Set working directory
setwd('C:/Users/can02/mystuff/subsequent-drought')
#Increase the memory limit for R. Helps with spatially explicit analyses.
# memory.limit()
memory.limit(32000)
# memory.limit()
#Read in csv data for Regression Data Sets
dir_in <- "D:\\Large_Files\\Landsat"
all.ca <- read.csv(file.path(dir_in, "Regression_all_socal_300m_v23.csv"))
all.ca
#Calculate the difference between SPI48 2002 and SPI48 2015
all.ca$dSPI48 <- abs(all.ca$spi48_09_2015 - all.ca$spi48_09_2002)
#Adding a drought sequence column to the data set
all.ca <- all.ca %>% mutate(drought.sequence = case_when((spi48_09_2002 <= -1.5) & (spi48_09_2015 <= -1.5) & (dSPI48 <= 0.5) ~ 'Both Droughts',
(spi48_09_2015 <= -1.5) & (spi48_09_2002 > spi48_09_2015) & (spi48_09_2002 > -1.5) & (dSPI48 > 0.5) ~ '2nd Drought Only',
(spi48_09_2002) <= -1.5 & (spi48_09_2002 < spi48_09_2015) & (spi48_09_2015 > -1.5) & (dSPI48 > 0.5) ~ '1st Drought Only'))
# all.ca %>% dplyr::select(dNDMI_2004)
#Select columns of data
all.ca.1stDrought <- dplyr::select(all.ca, c(system.index, NDMI_1999, dNDMI_2004, dET_2004, dBiomass_2004, PET_4yr_2002, ppt_4yr_2002, tmax_4yr_2002, ET_4yr_2002, ET_1999, biomass_1999, ADS_2004, spi48_09_2002, elevation, latitude, longitude, USFS_zone, drought.sequence))
#Add the year of the 1999-2002 data
all.ca.1stDrought$drought <- '1999-2002'
#Rename the columns
colnames(all.ca.1stDrought) <- c('pixel.id','NDMI', 'dNDMI', 'dET', 'dBiomass', 'PET_4yr', 'ppt_4yr', 'tmax_4yr', 'ET_4yr', 'ET', 'biomass', 'ADS', 'spi48', 'elevation', 'latitude', 'longitude', 'USFS', 'sequence', 'drought')
#Select columns of the 2012-2015 data
all.ca.2ndDrought <- dplyr::select(all.ca, c(system.index, NDMI_2012, dNDMI_2017, dET_2017, dBiomass_2017, PET_4yr_2015, ppt_4yr_2015, tmax_4yr_2015, ET_4yr_2015, ET_2012, biomass_2012, ADS_2017, spi48_09_2015, elevation, latitude, longitude, USFS_zone, drought.sequence))
#Add the year of the 2012-2015 data
all.ca.2ndDrought$drought <- '2012-2015'
#Rename the columns
colnames(all.ca.2ndDrought) <- c('pixel.id', 'NDMI', 'dNDMI', 'dET', 'dBiomass', 'PET_4yr', 'ppt_4yr', 'tmax_4yr', 'ET_4yr', 'ET', 'biomass', 'ADS', 'spi48', 'elevation', 'latitude', 'longitude', 'USFS', 'sequence', 'drought')
#Combine all the data in one data frame
all.ca.combined <- rbind(all.ca.1stDrought, all.ca.2ndDrought)
#Translate the region code to text
all.ca.combined$region[all.ca.combined$USFS == 261] <- "Sierra Nevada"
all.ca.combined$region[all.ca.combined$USFS == 262] <- "Southern California"
#Convert the ADS data to categorical mortality or no mortality
all.ca.combined <- all.ca.combined %>% mutate(ADS.cat = case_when(
(ADS) >= 5 ~ 1, #mortality
(ADS) < 5 ~ 0)) #no mortality
#Make drought sequence into dummy categorical variables for statistical analysis
all.ca.sample <- all.ca.combined %>% mutate(sequence.f = case_when(
sequence == 'Both Droughts' ~ 0,
sequence == '2nd Drought Only' ~ 1))
#Make years into dummy variables for statistical analysis
all.ca.sample <- all.ca.sample %>% mutate(drought.f = case_when(
drought == '1999-2002' ~ 0,
drought == '2012-2015' ~ 1))
#Select the drought sequence samples and data columns for analysis
dataset <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' | sequence == '2012-2015 Only') %>%
dplyr::select('PET_4yr', 'NDMI', 'dNDMI', 'drought.f', 'sequence.f', 'biomass', 'pixel.id', 'tmax_4yr', 'ADS.cat')
#Convert the dummy variables to a numeric format
dataset$sequence.f <- as.numeric(dataset$sequence.f)
dataset$drought.f <- as.numeric(dataset$drought.f)
#Calculate sample size for 1999-2002 and proportion impacted by drought
all.ca.combined %>% dplyr::filter(drought == '1999-2002' & spi48 <= -1.5) %>% count()
all.ca.combined %>% dplyr::filter(drought == '1999-2002' & spi48 <= -1.5) %>% count() / all.ca.combined %>% dplyr::filter(drought == '1999-2002') %>% count()
#Calculate sample sizes for 2012-2015 and proportion impacted by drought
all.ca.combined %>% dplyr::filter(drought == '2012-2015' & spi48 <= -1.5) %>% count()
all.ca.combined %>% dplyr::filter(drought == '2012-2015' & spi48 <= -1.5) %>% count() / all.ca.combined %>% dplyr::filter(drought == '2012-2015') %>% count()
#Convert dummy variable to factors
all.ca.sample$sequence.f <- all.ca.sample$sequence.f
all.ca.sample$drought.f <- all.ca.sample$drought.f
#Convert dummy variables to factors
dataset$sequence.f <- as.factor(dataset$sequence.f)
dataset$drought.f <- as.factor(dataset$drought.f)
#Create a task to undersample the drought sequence data by a factor of 0.2 for 2012-2015 Only
task = makeClassifTask(data = dataset, target = "sequence.f")
task.under <- undersample(task, rate = 0.2)
#The undersampled dataset
dataset.under <- getTaskData(task.under)
#Scale data sets to help with relative importance analysis.
dataset.under$dNDMI.scale <- scale(dataset.under$dNDMI)
dataset.under$PET_4yr.scale <- scale(dataset.under$PET_4yr)
dataset.under$biomass.scale <- scale(dataset.under$biomass)
dataset.under$tmax_4yr.scale <- scale(dataset.under$tmax_4yr)
dataset.under$sequence.scale <- scale(as.numeric(dataset.under$sequence.f))
dataset.under$drought.scale <- scale(as.numeric(dataset.under$drought.f))
#The full multiple regression linear model
dndmi.under.lm = lm(data = dataset.under,
formula = dNDMI ~ drought.f * sequence.f + PET_4yr + tmax_4yr + biomass)
#Get the model results as a datafram
df.dndmi.lm <- dndmi.under.lm %>% tidy() %>% as.data.frame()
#Label the columns of the data frame
df.dndmi.lm$variable <- c('Intercept', 'Time Period', 'Drought Sequence', 'four-year Pr-ET', 'four-year Temperature', 'Biomass', 'Time Period:Drought Sequence')
#Calculate the relative importance of model variables with a relative weight analysis.
dndmi.relimp <- calc.relimp(dndmi.under.lm, rela = TRUE, type = "lmg")
#Add the results of the relative weigth analysis to the data frame
df.dndmi.lm$relimp <- c(0, 0.03706293, 0.01952194, 0.36576597, 0.09262433, 0.02743045, 0.45759438)
#Covert the relative weight analysis outputs as percentages
df.dndmi.lm$relimp.pct <- df.dndmi.lm$relimp * 100
#Create a table of the relative weight analysis results
df.dndmi.tbl <- df.dndmi.lm %>% dplyr::select(variable, estimate, std.error, statistic, p.value, relimp.pct)
#Update the relative weight analysis column names
colnames(df.dndmi.tbl) <- c('Variable', 'Coefficient', 'Standard Error', 'T-Statistic', 'p-value', 'Relative Importance (%)')
#Create the data table with a title
tba <- kbl(df.dndmi.tbl, caption = "Table S4: Die-off (dNDMI) Multiple Linear Regression", digits = 3) %>% kable_classic_2(font_size = 14, full_width = F)
#Export the data table as a .PNG file
as_image(x = tba, width = 6, file = "STable4_multiple_regression_results.png", zoom = 5.0)
#Convert the dummy data back to a numeric format
dataset.under$sequence.f <- as.numeric(dataset.under$sequence.f)
dataset.under$drought.f <- as.numeric(dataset.under$drought.f)
#Filter the data into subsets for modeling
all.ca.both.1999 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002' & !is.na(sequence))
all.ca.both.2012 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '2012-2015' & !is.na(sequence))
all.ca.second.1999 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002' & !is.na(sequence))
all.ca.second.2012 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '2012-2015' & !is.na(sequence))
# #Linear Models for dNDMI ~ Pr-ET
#Models for Both Droughts
all.ca.both.1999.lm <- lm(data = all.ca.both.1999, dNDMI ~ PET_4yr) # 1999-2002 Model
all.ca.both.2012.lm <- lm(data = all.ca.both.2012, dNDMI ~ PET_4yr) # 2012-2015 Model
#Models for 2012-2015 Only
all.ca.second.1999.lm <- lm(data = all.ca.second.1999, dNDMI ~ PET_4yr) # 1999-2002 Model
all.ca.second.2012.lm <- lm(data = all.ca.second.2012, dNDMI ~ PET_4yr) # 2012-2015 Model
#Calculate the sgemented model
all.ca.both.1999.seg <- segmented(all.ca.both.1999.lm)
all.ca.second.2012.seg <- segmented(all.ca.second.2012.lm)
#Add predicted dNDMI values
all.ca.both.1999$dNDMI_predict = predict(all.ca.both.1999.seg)
all.ca.both.2012$dNDMI_predict = predict(all.ca.both.2012.lm )
all.ca.second.1999$dNDMI_predict = predict(all.ca.second.1999.lm)
all.ca.second.2012$dNDMI_predict = predict(all.ca.second.2012.seg)
#Recombine the data frames with the model fitted dNDMI as a column
all.ca.models <- rbind(all.ca.both.1999, all.ca.both.2012, all.ca.second.1999, all.ca.second.2012)
#R-Squared values for the four models
r2.a  <- format(summary(all.ca.both.1999.seg)$r.squared, digits = 3)
r2.b <- format(summary(all.ca.both.2012.lm)$r.squared, digits = 2)
r2.c <- format(summary(all.ca.second.1999.lm)$r.squared, digits = 1)
r2.d <- format(summary(all.ca.second.2012.seg)$r.squared, digits = 3)
#Create a data.frame of R.squared values
r2.text <- data.frame(
label = c(as.character(as.expression(substitute(italic(R)^2~"="~r2, list(r2 =r2.a)))),
as.character(as.expression(substitute(italic(R)^2~"="~r2, list(r2 = r2.b)))),
as.character(as.expression(substitute(italic(R)^2~"="~r2, list(r2 = r2.c)))),
as.character(as.expression(substitute(italic(R)^2~"="~r2, list(r2 = r2.d))))
),
sequence = c('Both Droughts', 'Both Droughts', '2nd Drought Only', '2nd Drought Only'),
drought = c('1999-2002', '2012-2015', '1999-2002', '2012-2015'),
x = c(2500, 2500, 2500, 2500),
y = c(-0.25, -0.25, -0.25, -0.25)
)
letter.text <- data.frame(label = c("a)", "b)", "c)", "d)"),
sequence   = c('Both Droughts', 'Both Droughts', '2nd Drought Only', '2nd Drought Only'),
drought = c('1999-2002', '2012-2015', '1999-2002',  '2012-2015'),
y     = c(-0.3, -0.3, -0.3, -0.3),
x     = c(-2400, -2400, -2400, -2400)
)
#Plot dNDMI versus Pr-ET by drought sequence and time period.
p3 <- ggscatter(all.ca.models, x = "PET_4yr", y = "dNDMI", point = FALSE) +
geom_bin2d(binwidth = c(100, 0.0075)) +
geom_line(data = all.ca.models, mapping = aes(x=PET_4yr, y=dNDMI_predict), size=2, color = 'black') +
theme_bw() +
ylab(label = "Die-off (dNDMI)") +  xlab(label = expression('Pr-ET (mm 4 yr'^-1*')')) +
geom_vline(xintercept = 0) +
geom_hline(yintercept = 0) +
geom_text(data = r2.text, mapping = aes(x = x, y = y, label = label), size = 3.5, parse = TRUE) +
geom_text(data = letter.text, mapping = aes(x = x, y = y, label = label), size = 5, fontface = "bold") +
labs(fill = "Grid Cells") +
theme(axis.text.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.title.y = element_text(size = 10),
plot.title = element_text(size = 10, hjust = 0.5), strip.text.x = element_text(size = 10, face = 'bold'), strip.text.y = element_text(size = 10)) + #Presentation text sizes.
scale_fill_gradient2(limits = c(10,370), breaks = c(10,100,200,300), midpoint = 185, low = "cornflowerblue", mid = "yellow", high = "red", na.value = 'transparent') +
ylim(0.1, -0.3) + xlim(-2500, 3500) + facet_grid(factor(sequence, levels = c('Both Droughts', '2nd Drought Only')) ~ drought,
labeller = labeller(drought = c('1999-2002'='Response to 1st Period', '2012-2015'='Response to 2nd Period'),
c('Both Droughts' = 'Exposed to Both Droughts', '2nd Drought Only' = 'Exposed to 2nd Drought Only')))
#Add a shared legend in a customized position on the figure
p4 <- p3 + theme(
legend.background = element_rect(colour = NA, fill = NA), # This removes the white square behind the legend
legend.justification = c(1, 0),
legend.position = c(0.68, 0.8),
legend.text = element_text(size = 10),
legend.title = element_text(size = 10),
legend.direction = "vertical") +
guides(fill = guide_colorbar(barwidth = 1, barheight = 3,
title.position = "top",
title.hjust = 0.5,
ticks.colour = "black"))
p4
#Save the figure as a .png file
ggsave(filename = 'Fig5_regression_faceted_plot.png', device = 'png', height=16, width=16, units = 'cm', dpi=900)
p3 <- ggscatter(all.ca.models, x = "PET_4yr", y = "dNDMI", point = FALSE) +
geom_bin2d(binwidth = c(100, 0.0075)) +
geom_line(data = all.ca.models, mapping = aes(x=PET_4yr, y=dNDMI_predict), size=2, color = 'black') +
theme_bw() +
ylab(label = "Die-off (dNDMI)") +  xlab(label = expression('Pr-ET (mm 4 yr'^-1*')')) +
geom_vline(xintercept = 0) +
geom_hline(yintercept = 0) +
geom_text(data = r2.text, mapping = aes(x = x, y = y, label = label), size = 3.5, parse = TRUE) +
geom_text(data = letter.text, mapping = aes(x = x, y = y, label = label), size = 5, fontface = "bold") +
labs(fill = "Grid Cells") +
theme(axis.text.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.title.y = element_text(size = 10),
plot.title = element_text(size = 10, hjust = 0.5), strip.text.x = element_text(size = 10, face = 'bold'), strip.text.y = element_text(size = 10)) + #Presentation text sizes.
scale_fill_gradient2(limits = c(10,370), breaks = c(10,100,200,300), midpoint = 185, low = "cornflowerblue", mid = "yellow", high = "red", na.value = 'transparent') +
ylim(0.1, -0.3) + xlim(-2500, 3500) + facet_grid(factor(sequence, levels = c('Both Droughts', '2nd Drought Only')) ~ drought,
labeller = labeller(drought = c('1999-2002'='Response to 1st Period', '2012-2015'='Response to 2nd Period'),
sequence = c('Both Droughts' = 'Exposed to Both Droughts', '2nd Drought Only' = 'Exposed to 2nd Drought Only')))
#Add a shared legend in a customized position on the figure
p4 <- p3 + theme(
legend.background = element_rect(colour = NA, fill = NA), # This removes the white square behind the legend
legend.justification = c(1, 0),
legend.position = c(0.68, 0.8),
legend.text = element_text(size = 10),
legend.title = element_text(size = 10),
legend.direction = "vertical") +
guides(fill = guide_colorbar(barwidth = 1, barheight = 3,
title.position = "top",
title.hjust = 0.5,
ticks.colour = "black"))
p4
#Save the figure as a .png file
ggsave(filename = 'Fig5_regression_faceted_plot.png', device = 'png', height=16, width=16, units = 'cm', dpi=900)
p3 <- ggscatter(all.ca.models, x = "PET_4yr", y = "dNDMI", point = FALSE) +
geom_bin2d(binwidth = c(100, 0.0075)) +
geom_line(data = all.ca.models, mapping = aes(x=PET_4yr, y=dNDMI_predict), size=2, color = 'black') +
theme_bw() +
ylab(label = "Die-off (dNDMI)") +  xlab(label = expression('Pr-ET (mm 4 yr'^-1*')')) +
geom_vline(xintercept = 0) +
geom_hline(yintercept = 0) +
geom_text(data = r2.text, mapping = aes(x = x, y = y, label = label), size = 3.5, parse = TRUE) +
geom_text(data = letter.text, mapping = aes(x = x, y = y, label = label), size = 5, fontface = "bold") +
labs(fill = "Grid Cells") +
theme(axis.text.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.title.y = element_text(size = 10),
plot.title = element_text(size = 10, hjust = 0.5), strip.text.x = element_text(size = 10, face = 'bold'), strip.text.y = element_text(size = 10)) + #Presentation text sizes.
scale_fill_gradient2(limits = c(10,370), breaks = c(10,100,200,300), midpoint = 185, low = "cornflowerblue", mid = "yellow", high = "red", na.value = 'transparent') +
ylim(0.1, -0.3) + xlim(-2500, 3500) + facet_grid(factor(sequence, levels = c('Both Droughts', '2nd Drought Only')) ~ drought,
labeller = as_labeller(drought = c('1999-2002'='Response to 1st Period', '2012-2015'='Response to 2nd Period'),
sequence = c('Both Droughts' = 'Exposed to Both Droughts', '2nd Drought Only' = 'Exposed to 2nd Drought Only')))
#Add a shared legend in a customized position on the figure
p4 <- p3 + theme(
legend.background = element_rect(colour = NA, fill = NA), # This removes the white square behind the legend
legend.justification = c(1, 0),
legend.position = c(0.68, 0.8),
legend.text = element_text(size = 10),
legend.title = element_text(size = 10),
legend.direction = "vertical") +
guides(fill = guide_colorbar(barwidth = 1, barheight = 3,
title.position = "top",
title.hjust = 0.5,
ticks.colour = "black"))
p4
#Save the figure as a .png file
ggsave(filename = 'Fig5_regression_faceted_plot.png', device = 'png', height=16, width=16, units = 'cm', dpi=900)
p3 <- ggscatter(all.ca.models, x = "PET_4yr", y = "dNDMI", point = FALSE) +
geom_bin2d(binwidth = c(100, 0.0075)) +
geom_line(data = all.ca.models, mapping = aes(x=PET_4yr, y=dNDMI_predict), size=2, color = 'black') +
theme_bw() +
ylab(label = "Die-off (dNDMI)") +  xlab(label = expression('Pr-ET (mm 4 yr'^-1*')')) +
geom_vline(xintercept = 0) +
geom_hline(yintercept = 0) +
geom_text(data = r2.text, mapping = aes(x = x, y = y, label = label), size = 3.5, parse = TRUE) +
geom_text(data = letter.text, mapping = aes(x = x, y = y, label = label), size = 5, fontface = "bold") +
labs(fill = "Grid Cells") +
theme(axis.text.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.title.y = element_text(size = 10),
plot.title = element_text(size = 10, hjust = 0.5), strip.text.x = element_text(size = 10, face = 'bold'), strip.text.y = element_text(size = 10, face = 'bold')) + #Presentation text sizes.
scale_fill_gradient2(limits = c(10,370), breaks = c(10,100,200,300), midpoint = 185, low = "cornflowerblue", mid = "yellow", high = "red", na.value = 'transparent') +
ylim(0.1, -0.3) + xlim(-2500, 3500) + facet_grid(factor(sequence, levels = c('Both Droughts', '2nd Drought Only')) ~ drought,
labeller = as_labeller(c('1999-2002'='Response to 1st Period', '2012-2015'='Response to 2nd Period',
'Both Droughts' = 'Exposed to Both Droughts', '2nd Drought Only' = 'Exposed to 2nd Drought Only')))
#Add a shared legend in a customized position on the figure
p4 <- p3 + theme(
legend.background = element_rect(colour = NA, fill = NA), # This removes the white square behind the legend
legend.justification = c(1, 0),
legend.position = c(0.68, 0.8),
legend.text = element_text(size = 10),
legend.title = element_text(size = 10),
legend.direction = "vertical") +
guides(fill = guide_colorbar(barwidth = 1, barheight = 3,
title.position = "top",
title.hjust = 0.5,
ticks.colour = "black"))
p4
#Save the figure as a .png file
ggsave(filename = 'Fig5_regression_faceted_plot.png', device = 'png', height=16, width=16, units = 'cm', dpi=900)
p <- c('dplyr','tidyr','ggplot2','ggpubr','segmented', 'patchwork','RColorBrewer','gt', 'gtsummary',
'webshot', 'kableExtra', 'broom', 'ggpmisc', 'relaimpo', 'mlr', 'caret', 'stats', 'purrr', 'gstat',
'sp', 'rgdal', 'raster', 'sf', 'elsa', 'nlme')
#Install a package
#Load packages
lapply(p,require,character.only=TRUE)
#Set working directory
setwd('C:/Users/can02/mystuff/subsequent-drought')
#Increase the memory limit for R. Helps with spatially explicit analyses.
# memory.limit()
memory.limit(32000)
# memory.limit()
#Read in csv data for Regression Data Sets
dir_in <- "D:\\Large_Files\\Landsat"
all.ca <- read.csv(file.path(dir_in, "Regression_all_socal_300m_v23.csv"))
all.ca
#Calculate the difference between SPI48 2002 and SPI48 2015
all.ca$dSPI48 <- abs(all.ca$spi48_09_2015 - all.ca$spi48_09_2002)
#Adding a drought sequence column to the data set
all.ca <- all.ca %>% mutate(drought.sequence = case_when((spi48_09_2002 <= -1.5) & (spi48_09_2015 <= -1.5) & (dSPI48 <= 0.5) ~ 'Both Droughts',
(spi48_09_2015 <= -1.5) & (spi48_09_2002 > spi48_09_2015) & (spi48_09_2002 > -1.5) & (dSPI48 > 0.5) ~ '2nd Drought Only',
(spi48_09_2002) <= -1.5 & (spi48_09_2002 < spi48_09_2015) & (spi48_09_2015 > -1.5) & (dSPI48 > 0.5) ~ '1st Drought Only'))
# all.ca %>% dplyr::select(dNDMI_2004)
#Select columns of data
all.ca.1stDrought <- dplyr::select(all.ca, c(system.index, NDMI_1999, dNDMI_2004, dET_2004, dBiomass_2004, PET_4yr_2002, ppt_4yr_2002, tmax_4yr_2002, ET_4yr_2002, ET_1999, biomass_1999, ADS_2004, spi48_09_2002, elevation, latitude, longitude, USFS_zone, drought.sequence))
#Add the year of the 1999-2002 data
all.ca.1stDrought$drought <- '1999-2002'
#Rename the columns
colnames(all.ca.1stDrought) <- c('pixel.id','NDMI', 'dNDMI', 'dET', 'dBiomass', 'PET_4yr', 'ppt_4yr', 'tmax_4yr', 'ET_4yr', 'ET', 'biomass', 'ADS', 'spi48', 'elevation', 'latitude', 'longitude', 'USFS', 'sequence', 'drought')
#Select columns of the 2012-2015 data
all.ca.2ndDrought <- dplyr::select(all.ca, c(system.index, NDMI_2012, dNDMI_2017, dET_2017, dBiomass_2017, PET_4yr_2015, ppt_4yr_2015, tmax_4yr_2015, ET_4yr_2015, ET_2012, biomass_2012, ADS_2017, spi48_09_2015, elevation, latitude, longitude, USFS_zone, drought.sequence))
#Add the year of the 2012-2015 data
all.ca.2ndDrought$drought <- '2012-2015'
#Rename the columns
colnames(all.ca.2ndDrought) <- c('pixel.id', 'NDMI', 'dNDMI', 'dET', 'dBiomass', 'PET_4yr', 'ppt_4yr', 'tmax_4yr', 'ET_4yr', 'ET', 'biomass', 'ADS', 'spi48', 'elevation', 'latitude', 'longitude', 'USFS', 'sequence', 'drought')
#Combine all the data in one data frame
all.ca.combined <- rbind(all.ca.1stDrought, all.ca.2ndDrought)
#Translate the region code to text
all.ca.combined$region[all.ca.combined$USFS == 261] <- "Sierra Nevada"
all.ca.combined$region[all.ca.combined$USFS == 262] <- "Southern California"
#Convert the ADS data to categorical mortality or no mortality
all.ca.combined <- all.ca.combined %>% mutate(ADS.cat = case_when(
(ADS) >= 5 ~ 1, #mortality
(ADS) < 5 ~ 0)) #no mortality
#Make drought sequence into dummy categorical variables for statistical analysis
all.ca.sample <- all.ca.combined %>% mutate(sequence.f = case_when(
sequence == 'Both Droughts' ~ 0,
sequence == '2nd Drought Only' ~ 1))
#Make years into dummy variables for statistical analysis
all.ca.sample <- all.ca.sample %>% mutate(drought.f = case_when(
drought == '1999-2002' ~ 0,
drought == '2012-2015' ~ 1))
#Testing out a spatial data.frame to check for spatial autocorrelation with a semivariogram
#Setting variable for ESPG 5070, proj4 crs
c <- raster::crs("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs")
#directory for raster files
socal_dir <- "D:\\Large_Files\\socal"
#dNDMI 2004
dndmi.2004 <- raster::raster(file.path(socal_dir, 'dNDMI_2004_bigger_region_300m_v4.tif'))
raster::crs(dndmi.2004) <- c
dndmi.2004.m <- is.na(dndmi.2004)
dndmi.2004.mask <- raster::mask(dndmi.2004, mask = dndmi.2004.m, maskvalue = 1)
#dNDMI 2017
dndmi.2017 <- raster::raster(file.path(socal_dir, 'dNDMI_2017_bigger_region_300m_v4.tif'))
raster::crs(dndmi.2017) <- c
dndmi.2017.m <- is.na(dndmi.2017)
dndmi.2017.mask <- raster::mask(dndmi.2017, mask = dndmi.2017.m, maskvalue = 1)
dndmi.2004.30m.1 <- raster::raster(file.path(socal_dir, 'dNDMI_2004_bigger_region_30m-1.tif'))
dndmi.2004.30m.2 <- raster::raster(file.path(socal_dir, 'dNDMI_2004_bigger_region_30m-2.tif'))
dndmi.2004.30m <- raster::merge(dndmi.2004.30m.1, dndmi.2004.30m.2)
raster::crs(dndmi.2004.30m) <- c
dndmi.2004.30m.m <- is.na(dndmi.2004.30m)
dndmi.2004.30m.mask <- raster::mask(dndmi.2004.30m, mask = dndmi.2004.30m.m, maskvalue = 1)
v.2004.30m <- elsa::Variogram(dndmi.2004.30m.mask, width = 30, cutoff = 10000, s = 10000)
png(file = 'SFig_17_dNDMI_2004_30m_semivariogram.png', width=12, height=8, units="cm", res=900)
plot(v.2004.30m, ylab = 'Semivariance', xlab = 'Distance (m)', main = 'dNDMI 2004 30-meter Variogram')
dev.off()
#dNDMI 2004, 30 meters
dndmi.2004.30m.1 <- raster::raster(file.path(socal_dir, 'dNDMI_2004_bigger_region_30m-1.tif'))
dndmi.2004.30m.1 <- raster::raster(file.path(sub_dir, 'dNDMI_2004_bigger_region_30m-1.tif'))
dndmi.2004.30m.2 <- raster::raster(file.path(sub_dir, 'dNDMI_2004_bigger_region_30m-2.tif'))
dndmi.2004.30m <- raster::merge(dndmi.2004.30m.1, dndmi.2004.30m.2)
raster::crs(dndmi.2004.30m) <- c
dndmi.2004.30m.m <- is.na(dndmi.2004.30m)
dndmi.2004.30m.mask <- raster::mask(dndmi.2004.30m, mask = dndmi.2004.30m.m, maskvalue = 1)
v.2004.30m <- elsa::Variogram(dndmi.2004.30m.mask, width = 30, cutoff = 10000, s = 10000)
png(file = 'SFig_17_dNDMI_2004_30m_semivariogram.png', width=12, height=8, units="cm", res=900)
plot(v.2004.30m, ylab = 'Semivariance', xlab = 'Distance (m)', main = 'dNDMI 2004 30-meter Variogram')
dev.off()
sub_dir <- "D:\\Subsequent_Drought"
dndmi.2004.30m.1 <- raster::raster(file.path(sub_dir, 'dNDMI_2004_bigger_region_30m-1.tif'))
dndmi.2004.30m.2 <- raster::raster(file.path(sub_dir, 'dNDMI_2004_bigger_region_30m-2.tif'))
dndmi.2004.30m <- raster::merge(dndmi.2004.30m.1, dndmi.2004.30m.2)
raster::crs(dndmi.2004.30m) <- c
dndmi.2004.30m.m <- is.na(dndmi.2004.30m)
dndmi.2004.30m.mask <- raster::mask(dndmi.2004.30m, mask = dndmi.2004.30m.m, maskvalue = 1)
v.2004.30m <- elsa::Variogram(dndmi.2004.30m.mask, width = 30, cutoff = 10000, s = 10000)
png(file = 'SFig_17_dNDMI_2004_30m_semivariogram.png', width=12, height=8, units="cm", res=900)
plot(v.2004.30m, ylab = 'Semivariance', xlab = 'Distance (m)', main = 'dNDMI 2004 30-meter Variogram')
dev.off()
writeRaster(dndmi.2004.30m, filename=file.path(sub_dir, "dNDMI_2004_bigger_region_30m.tif"), format="GTiff", overwrite=TRUE)
#Save the raster mask for later
writeRaster(dndmi.2004.30m.m, filename=file.path(sub_dir, "dNDMI_2004_bigger_region_30m_mask.tif"), format="GTiff", overwrite=TRUE)
spplot(dndmi.2004.30m)
v.2004.30m <- elsa::Variogram(dndmi.2004.30m.mask)
v.2004.30m <- gstat::variogram(dndmi.2004.30m.mask)
dndmi.2004.30m.m <- is.na(dndmi.2004.30m, width = 300, cutoff = 10000, s = 10000)
v.2004.30m <- elsa::Variogram(dndmi.2004.30m.mask, width = 300, cutoff = 10000, s = 10000)
png(file = 'SFig_17_dNDMI_2004_30m_semivariogram.png', width=12, height=8, units="cm", res=900)
plot(v.2004.30m, ylab = 'Semivariance', xlab = 'Distance (m)', main = 'dNDMI 2004 30-meter Variogram')
dev.off()
