all.ca.sample <- all.ca.combined %>% mutate(sequence.c = case_when(
sequence == 'Both Droughts' ~ 0,
sequence == '2nd Drought Only' ~ 1))
#Make years into dummy variables for statistical analysis
all.ca.sample <- all.ca.sample %>% mutate(drought.c = case_when(
drought == '1999-2002' ~ 0,
drought == '2012-2015' ~ 1))
#Select the drought sequence samples and data columns for analysis
dataset <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' | sequence == '2nd Drought Only') %>%
dplyr::select('PET_4yr', 'dNDMI', 'drought.c', 'sequence.c', 'biomass', 'pixel.id', 'tmax_4yr', 'ADS.cat')
ADS.1999.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.both.alive
ADS.1999.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.both.dead
ADS.2015.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.both.alive
ADS.2015.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.both.dead
ADS.1999.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2012-2015 Only' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.second.alive
ADS.1999.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2012-2015 Only' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.second.dead
ADS.2015.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2012-2015 Only' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.second.alive
ADS.2015.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2012-2015 Only' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.second.dead
#Create a frequency matrix for a chi-square test
ADS <- matrix(c(as.numeric(ADS.1999.both.dead), as.numeric(ADS.2015.both.dead), as.numeric(ADS.1999.second.dead), as.numeric(ADS.2015.second.dead),
as.numeric(ADS.1999.both.alive), as.numeric(ADS.2015.both.alive), as.numeric(ADS.1999.second.alive), as.numeric(ADS.2015.second.alive)), ncol=2)
#Give the matrix column and row names
colnames(ADS) <- c("Mortality", "No Mortality")
rownames(ADS) <- c('Both Droughts: 1999-2002', 'Both Droughts: 2012-2015', '2012-2015 Only: 1999-2002','2012-2015 Only: 2012-2015')
#Convert the matrix to a data frame
ADS <- as.data.frame(ADS)
#Do the chi-squared test
mychi <- chisq.test(ADS)
#Print the results of the chi-square
mychi
#Print the expected result if there is no association
mychi$expected
ADS.1999.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.both.alive
ADS.1999.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.both.dead
ADS.2015.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.both.alive
ADS.2015.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.both.dead
ADS.1999.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.second.alive
ADS.1999.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.second.dead
ADS.2015.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.second.alive
ADS.2015.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.second.dead
#Create a frequency matrix for a chi-square test
ADS <- matrix(c(as.numeric(ADS.1999.both.dead), as.numeric(ADS.2015.both.dead), as.numeric(ADS.1999.second.dead), as.numeric(ADS.2015.second.dead),
as.numeric(ADS.1999.both.alive), as.numeric(ADS.2015.both.alive), as.numeric(ADS.1999.second.alive), as.numeric(ADS.2015.second.alive)), ncol=2)
#Give the matrix column and row names
colnames(ADS) <- c("Mortality", "No Mortality")
rownames(ADS) <- c('Both Droughts: 1999-2002', 'Both Droughts: 2012-2015', '2nd Drought Only: 1999-2002','2nd Drought Only: 2012-2015')
#Convert the matrix to a data frame
ADS <- as.data.frame(ADS)
#Do the chi-squared test
mychi <- chisq.test(ADS)
#Print the results of the chi-square
mychi
#Print the expected result if there is no association
mychi$expected
ADS
#Print the results of the chi-square
mychi
#Do the chi-squared test
mychi <- chisq.test(ADS)
second.2002 <- all.ca.sample %>% filter(sequence == '2012-2015 Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% sum()
second.2002.total <- all.ca.sample %>% filter(sequence == '2012-2015 Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% count()
second.2002 / second.2002.total
#2012-2015 Only sample in 2012-2015
second.2015 <- all.ca.sample %>% filter(sequence == '2012-2015 Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% sum()
second.2015.total <- all.ca.sample %>% filter(sequence == '2012-2015 Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% count()
second.2015 / second.2015.total
second.2002 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% sum()
second.2002.total <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% count()
second.2002 / second.2002.total
#2nd Drought Only sample in 2012-2015
second.2015 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% sum()
second.2015.total <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% count()
second.2015 / second.2015.total
#Both Droughts sample in 1999-2002
both.2002 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% sum()
both.2002.total <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% count()
both.2002 / both.2002.total
#Both Droughts sample in 2012-2015
both.2015 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% sum()
both.2015.total <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% count()
both.2015 / both.2015.total
all.ca.combined <- all.ca.combined %>% mutate(ADS.cat = case_when(
(ADS) >= 8 ~ 1, #mortality
(ADS) < 8 ~ 0)) #no mortality
ADS.1999.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.both.alive
ADS.1999.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.both.dead
ADS.2015.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.both.alive
ADS.2015.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.both.dead
ADS.1999.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.second.alive
ADS.1999.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.second.dead
ADS.2015.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.second.alive
ADS.2015.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.second.dead
#Create a frequency matrix for a chi-square test
ADS <- matrix(c(as.numeric(ADS.1999.both.dead), as.numeric(ADS.2015.both.dead), as.numeric(ADS.1999.second.dead), as.numeric(ADS.2015.second.dead),
as.numeric(ADS.1999.both.alive), as.numeric(ADS.2015.both.alive), as.numeric(ADS.1999.second.alive), as.numeric(ADS.2015.second.alive)), ncol=2)
#Give the matrix column and row names
colnames(ADS) <- c("Mortality", "No Mortality")
rownames(ADS) <- c('Both Droughts: 1999-2002', 'Both Droughts: 2012-2015', '2nd Drought Only: 1999-2002','2nd Drought Only: 2012-2015')
#Convert the matrix to a data frame
ADS <- as.data.frame(ADS)
ADS
#Do the chi-squared test
mychi <- chisq.test(ADS)
#Print the results of the chi-square
mychi
#Print the expected result if there is no association
mychi$expected
#Calculate proportion of ADS mortality and no mortality by drought sequence and time period
#2012-2015 Only sample in 1999-2002
second.2002 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% sum()
second.2002.total <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% count()
second.2002 / second.2002.total
#2nd Drought Only sample in 2012-2015
second.2015 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% sum()
second.2015.total <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% count()
second.2015 / second.2015.total
#Both Droughts sample in 1999-2002
both.2002 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% sum()
both.2002.total <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% count()
both.2002 / both.2002.total
#Both Droughts sample in 2012-2015
both.2015 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% sum()
both.2015.total <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% count()
both.2015 / both.2015.total
all.ca <- read.csv(file.path(dir_in, "Regression_all_socal_300m_v24.csv"))
#Calculate the difference between SPI48 2002 and SPI48 2015
all.ca$dSPI48 <- abs(all.ca$spi48_09_2015 - all.ca$spi48_09_2002)
#Adding a drought sequence column to the data set
all.ca <- all.ca %>% mutate(drought.sequence = case_when((spi48_09_2002 <= -1.5) & (spi48_09_2015 <= -1.5) & (dSPI48 <= 0.5) ~ 'Both Droughts',
(spi48_09_2015 <= -1.5) & (spi48_09_2002 > spi48_09_2015) & (spi48_09_2002 > -1.5) & (dSPI48 > 0.5) ~ '2nd Drought Only',
(spi48_09_2002) <= -1.5 & (spi48_09_2002 < spi48_09_2015) & (spi48_09_2015 > -1.5) & (dSPI48 > 0.5) ~ '1st Drought Only'))
#Check if PET_4yr_2009 is postive or negative
all.ca %>% filter(drought.sequence == 'Both Droughts') %>% dplyr::select(PET_4yr_2009, PET_4yr_2002, PET_4yr_2015) %>%
summarize(PET_2002.mean = mean(PET_4yr_2002), PET_2009.mean = mean(PET_4yr_2009), PET_2015.mean = mean(PET_4yr_2015))
#Select columns of data
all.ca.1stDrought <- dplyr::select(all.ca, c(system.index, dNDMI_2004, PET_4yr_2002, ppt_4yr_2002, tmax_4yr_2002, ET_4yr_2002, biomass_1999, ADS_2004, spi48_09_2002, elevation, latitude, longitude, USFS_zone, drought.sequence))
#Add the year of the 1999-2002 data
all.ca.1stDrought$drought <- '1999-2002'
#Rename the columns
colnames(all.ca.1stDrought) <- c('pixel.id', 'dNDMI', 'PET_4yr', 'ppt_4yr', 'tmax_4yr', 'ET_4yr', 'biomass', 'ADS', 'spi48', 'elevation', 'latitude', 'longitude', 'USFS', 'sequence', 'drought')
#Select columns of the 2012-2015 data
all.ca.2ndDrought <- dplyr::select(all.ca, c(system.index, dNDMI_2017, PET_4yr_2015, ppt_4yr_2015, tmax_4yr_2015, ET_4yr_2015, biomass_2012, ADS_2017, spi48_09_2015, elevation, latitude, longitude, USFS_zone, drought.sequence))
#Add the year of the 2012-2015 data
all.ca.2ndDrought$drought <- '2012-2015'
#Rename the columns
colnames(all.ca.2ndDrought) <- c('pixel.id', 'dNDMI', 'PET_4yr', 'ppt_4yr', 'tmax_4yr', 'ET_4yr', 'biomass', 'ADS', 'spi48', 'elevation', 'latitude', 'longitude', 'USFS', 'sequence', 'drought')
#Combine all the data in one data frame
all.ca.combined <- rbind(all.ca.1stDrought, all.ca.2ndDrought)
#Translate the region code to text
all.ca.combined$region[all.ca.combined$USFS == 261] <- "Sierra Nevada"
all.ca.combined$region[all.ca.combined$USFS == 262] <- "Southern California"
#Convert the ADS data to categorical mortality or no mortality
#Trying the ADS Categorical with a 3 threshold
all.ca.combined <- all.ca.combined %>% mutate(ADS.cat = case_when(
(ADS) >= 8 ~ 1, #mortality
(ADS) < 8 ~ 0)) #no mortality
#Make drought sequence into dummy categorical variables for statistical analysis
all.ca.sample <- all.ca.combined %>% mutate(sequence.c = case_when(
sequence == 'Both Droughts' ~ 0,
sequence == '2nd Drought Only' ~ 1))
#Make years into dummy variables for statistical analysis
all.ca.sample <- all.ca.sample %>% mutate(drought.c = case_when(
drought == '1999-2002' ~ 0,
drought == '2012-2015' ~ 1))
ADS.1999.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.both.alive
ADS.1999.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.both.dead
ADS.2015.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.both.alive
ADS.2015.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.both.dead
ADS.1999.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.second.alive
ADS.1999.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.second.dead
ADS.2015.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.second.alive
ADS.2015.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.second.dead
#Create a frequency matrix for a chi-square test
ADS <- matrix(c(as.numeric(ADS.1999.both.dead), as.numeric(ADS.2015.both.dead), as.numeric(ADS.1999.second.dead), as.numeric(ADS.2015.second.dead),
as.numeric(ADS.1999.both.alive), as.numeric(ADS.2015.both.alive), as.numeric(ADS.1999.second.alive), as.numeric(ADS.2015.second.alive)), ncol=2)
#Give the matrix column and row names
colnames(ADS) <- c("Mortality", "No Mortality")
rownames(ADS) <- c('Both Droughts: 1999-2002', 'Both Droughts: 2012-2015', '2nd Drought Only: 1999-2002','2nd Drought Only: 2012-2015')
#Convert the matrix to a data frame
ADS <- as.data.frame(ADS)
ADS
#Do the chi-squared test
mychi <- chisq.test(ADS)
#Print the results of the chi-square
mychi
#Print the expected result if there is no association
mychi$expected
#Calculate proportion of ADS mortality and no mortality by drought sequence and time period
#2012-2015 Only sample in 1999-2002
second.2002 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% sum()
second.2002.total <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% count()
second.2002 / second.2002.total
#2nd Drought Only sample in 2012-2015
second.2015 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% sum()
second.2015.total <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% count()
second.2015 / second.2015.total
#Both Droughts sample in 1999-2002
both.2002 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% sum()
both.2002.total <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% count()
both.2002 / both.2002.total
#Both Droughts sample in 2012-2015
both.2015 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% sum()
both.2015.total <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% count()
both.2015 / both.2015.total
p <- c('grid', 'gridExtra','dplyr', 'tidyr','ggplot2','ggpubr',
'patchwork','RColorBrewer','gt', 'gtsummary', 'webshot',
'stargazer', 'kableExtra', 'broom', 'svglite','sjPlot','purrr', 'magick', 'magrittr',
'knitr', 'xtable', 'mgcv')
# Load packages
lapply(p,require,character.only=TRUE)
#Set working directory
setwd('C:/Users/can02/mystuff/subsequent-drought')
#Directory to load data from
dir_in <- "D:\\Large_Files\\Landsat"
#Load CSV data into the script.
all.ca <- read.csv(file.path(dir_in, "Regression_all_socal_300m_v23.csv"))
#Calculate the difference in SPI48 between 2002 and 2015
all.ca$dSPI48 <- abs(all.ca$spi48_09_2015 - all.ca$spi48_09_2002)
#Sort pixels by drought sequence
all.ca <- all.ca %>% mutate(drought.sequence = case_when((spi48_09_2002 <= -1.5) & (spi48_09_2015 <= -1.5) & (dSPI48 <= 0.5) ~ 'Both Droughts',
(spi48_09_2015 <= -1.5) & (spi48_09_2002 > spi48_09_2015) & (spi48_09_2002 > -1.5) & (dSPI48 > 0.5) ~ '2012-2015 Only',
(spi48_09_2002) <= -1.5 & (spi48_09_2002 < spi48_09_2015) & (spi48_09_2015 > -1.5) & (dSPI48 > 0.5) ~ '1999-2002 Only'))
#Add Categorical ADS mortality data data
all.ca <- all.ca %>% mutate(ADS_2004.cat = case_when(
(ADS_2004) >= 8 ~ 1, #Mortality
(ADS_2004) < 8 ~ 0), #No Mortality
ADS_2017.cat = case_when(
(ADS_2017) >= 8 ~ 1, #Mortality
(ADS_2017) < 8 ~ 0)) #No Mortality
#Do binning by SPI48 and Pr-ET over four years.
all.ca.spi48 <- all.ca %>%
dplyr::mutate(socal = as.integer(USFS_zone == 262), sierra = as.integer(USFS_zone == 261)) %>% #Make new columns that have 0,1 for Sierra and socal to calculate proportions later
dplyr::mutate(spi48_09_2002.bin = cut(spi48_09_2002, breaks = seq(-3.5, 2, by = 0.1)),
spi48_09_2015.bin = cut(spi48_09_2015, breaks = seq(-3.5, 2, by = 0.1)),
) %>%
dplyr::group_by(spi48_09_2002.bin, spi48_09_2015.bin) %>%
dplyr::mutate(dNDMI_1994.mean = mean(dNDMI_1994)) %>%
dplyr::mutate(dNDMI_2004.mean = mean(dNDMI_2004)) %>%
dplyr::mutate(dNDMI_2017.mean = mean(dNDMI_2017)) %>%
dplyr::mutate(PET_4yr_1992.mean = mean(PET_4yr_1992)) %>%
dplyr::mutate(PET_4yr_2002.mean = mean(PET_4yr_2002)) %>%
dplyr::mutate(PET_4yr_2015.mean = mean(PET_4yr_2015)) %>%
dplyr::mutate(biomass_1999.mean = mean(biomass_1999)) %>%
dplyr::mutate(biomass_2012.mean = mean(biomass_2012)) %>%
dplyr::mutate(tmax_4yr_2002.mean = mean(tmax_4yr_2002)) %>%
dplyr::mutate(tmax_4yr_2015.mean = mean(tmax_4yr_2015)) %>%
dplyr::mutate(dNDMI_2004.median = median(dNDMI_2004)) %>%
dplyr::mutate(dNDMI_2017.median = median(dNDMI_2017)) %>%
dplyr::mutate(ADS_2004.mean = mean(ADS_2004)) %>%
dplyr::mutate(ADS_2017.mean = mean(ADS_2017)) %>%
dplyr::mutate(count = n()) %>%
dplyr::mutate(socal_count = sum(socal), sierra_count = sum(sierra)) %>%
dplyr::mutate(socal_prop = (socal_count / count) * 100, sierra_prop = (sierra_count / count) * 100) %>% # Calculate Sierra and SoCal proportions.
dplyr::mutate(dominant_region = as.integer(socal_prop > sierra_prop)) %>%
dplyr::mutate(ADS_2004.count = sum(ADS_2004.cat), ADS_2017.count = sum(ADS_2017.cat)) %>%
dplyr::mutate(ADS_2004.total = count, ADS_2017.total = count) %>%
dplyr::mutate(ADS_2004.prop = (ADS_2004.count / ADS_2004.total) * 100, ADS_2017.prop = (ADS_2017.count / ADS_2017.total) * 100) %>%
ungroup()
#Calculate proportion of Both Droughts in Socal
both.socal <- all.ca.spi48 %>% filter(drought.sequence == 'Both Droughts') %>% select(socal) %>% sum()
both.count <- all.ca.spi48 %>% filter(drought.sequence == 'Both Droughts') %>% select(socal) %>% count()
both.socal / both.count
#Calculate proportion of 2012-2015 Only in Sierra Nevada
second.socal <- all.ca.spi48 %>% filter(drought.sequence == '2012-2015 Only') %>% select(sierra) %>% sum()
second.count <- all.ca.spi48 %>% filter(drought.sequence == '2012-2015 Only') %>% select(sierra) %>% count()
second.socal / second.count
#Add columns for labeling plots.
all.ca.spi48$both <- 'Response During 1st Period'#'1999-2002'
all.ca.spi48$second <- 'Response During 2nd Period'#'2012-2015'
p3 <- ggplot(subset(all.ca.spi48, count >= 20), mapping = aes(x = spi48_09_2002, y = spi48_09_2015, fill = ADS_2004.prop, group = ADS_2004.prop)) +
geom_bin2d(mapping = aes(group = ADS_2004.prop), binwidth = c(0.1, 0.1)) + theme_bw() +
ylim(-3.5, 0) + xlim(-3, 2) +
ylab(NULL) +  xlab(NULL) +
# geom_vline(xintercept = 0, size = 0.25) +
# geom_hline(yintercept = 0, size = 0.25) +
geom_vline(xintercept = -1.5, size = 0.5, color = 'black', linetype='dashed') +
geom_hline(yintercept = -1.5, size = 0.5, color = 'black', linetype='dashed') +
guides(fill = guide_colorbar(barwidth = 5, barheight = 1, title.position = "top", title.hjust = 0.5, ticks.colour = "black")) +
theme(axis.text.x = element_text(size = 8), axis.text.y = element_text(size = 8), axis.title.x = element_text(size = 10),
axis.title.y = element_text(size = 10), legend.background = element_rect(colour = NA, fill = NA),
legend.justification = c(1, 0), legend.position = c(0.92, 0.6), legend.text = element_text(size = 6),
legend.title = element_text(size = 8), legend.direction = "horizontal", strip.text = element_text(size = 10)) +
scale_fill_gradient(name = "Mortality (% Grid Cells)", limits = c(0, 100), high = "#D41159", low = "lightyellow1", na.value = 'transparent') +
facet_wrap(~ both)
#Plot 2017 ADS mortality proportion for SPI48 2002 versus SPI48 2015
p4 <-ggplot(subset(all.ca.spi48, count >= 20), mapping = aes(x = spi48_09_2002, y = spi48_09_2015, fill = ADS_2017.prop, group = ADS_2017.prop)) +
geom_bin2d(mapping = aes(group = ADS_2017.prop), binwidth = c(0.1, 0.1)) + theme_bw() +
ylim(-3.5, 0) + xlim(-3, 2) +
ylab(NULL) +  xlab(NULL) +
# geom_vline(xintercept = 0, size = 0.25) +
# geom_hline(yintercept = 0, size = 0.25) +
geom_vline(xintercept = -1.5, size = 0.5, color = 'black', linetype='dashed') +
geom_hline(yintercept = -1.5, size = 0.5, color = 'black', linetype='dashed') +
guides(fill = "none") +
theme(axis.text.x = element_text(size = 8), axis.text.y = element_blank(), axis.title.x = element_text(size = 10),
axis.title.y = element_text(size = 10), strip.text = element_text(size = 10)) +
scale_fill_gradient(name = "Mortality (% Grid Cells)", limits = c(0, 100), high = "#D41159", low = "lightyellow1", na.value = 'transparent') +
annotate("text", x = 1, y = -0.5, label = "Neither \nDrought", size = 3) + annotate("text", x = -2.4, y = -0.5, label = "1st Drought \nOnly", size = 3) +
annotate("text", x = -2.4, y = -3, label = "Both \nDroughts", size = 3) + annotate("text", x = 1, y = -2, label = "2nd Drought \nOnly", size = 3) +
facet_wrap( ~ second)
#Combine the two figure panels into one
f2 <- ggarrange(p3, p4, ncol = 2, nrow = 1, widths = c(1, 0.95), common.legend = FALSE)
annotate_figure(f2, left = textGrob(label = "SPI48 2012-2015", rot = 90, hjust = 0.5, vjust = 0.3), bottom = textGrob(label = 'SPI48 1999-2002', vjust = 0.1, hjust = 0.5))
#Save the figure as a png
ggsave(filename = 'SFig1_ADS_prop_SPI48_grid_scatter.png', device = 'png', height=7, width=14, units = 'cm', dpi=900)
p <- c('ggpubr', 'tidyr', 'dplyr', 'ggmap', 'ggplot2', 'magrittr', 'raster', 'rgdal', 'sp', 'sf', 'RStoolbox',
'ncdf4', 'gtools', 'tigris', 'patchwork', 'rlist', 'ggspatial', 'svglite')
# install.packages(p,repo='https://cran.r-project.org/')
lapply(p,require,character.only=TRUE)
setwd('C:/Users/can02/mystuff/subsequent-drought')
land_dir <- "D:\\Large_Files\\Landsat"
socal_dir <- "D:\\Large_Files\\socal"
landfire_dir <- "D:\\Large_Files\\LANDFIRE"
frap_dir <- "D:\\Large_Files\\FRAP\\raster"
wrcc_dir <- "D:\\Large_Files\\WRCC"
data_dir <- "D:\\Large_Files\\WRCC\\All"
data_30m_dir <- "D:\\Large_Files\\WRCC\\SPI48_30m"
dir_out <- "D:\\Large_Files\\WRCC\\SPI48_30m"
work_dir <- "C:\\Users\\can02\\mystuff\\Goulden_Lab\\Forest_Dieback\\dieback\\figure_set\\final_figures_redo"
dir_ca <- "D:\\Large_Files\\TIGER\\ca-state-boundary"
dir_usgs <- "D:\\Large_Files\\USGS\\data"
dir_usfs <- "D:\\Large_Files\\USFS\\data\\subsections"
spi_dir <- "D:\\Large_Files\\WRCC\\All"
#CSV version of landsat data directory
dir_in <- "D:\\Large_Files\\Landsat"
#ESPG 5070, proj4 crs
c <- crs("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs")
#Read in a raster of general WGS 84 crs in PROJ4 code format
wg <- crs("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0")
#Increase the memory limit for R. Helps with spatially explicit analyses.
memory.limit(32000)
#Select USFS EcoRegions
usfs.regions <- st_read(file.path(dir_usfs, 'S_USA.EcomapSubsections.shp'))
usfs.sierra <- subset(usfs.regions, MAP_UNIT_S == 'M261Ep' | MAP_UNIT_S == 'M261Eq' | MAP_UNIT_S == 'M261Es' | MAP_UNIT_S == 'M261Eu' | MAP_UNIT_S == 'M261Er' | MAP_UNIT_S == 'M261Eo') # | MAP_UNIT_S == 'M261Ev') #MAP_UNIT_S == 'M261Et' |
usfs.sierra.union <- usfs.sierra %>% st_union()
usfs.socal <- subset(usfs.regions, MAP_UNIT_S == 'M262Bh' | MAP_UNIT_S == 'M262Bg' | MAP_UNIT_S == 'M262Bd' | MAP_UNIT_S == 'M262Be' | MAP_UNIT_S == 'M262Bf' | MAP_UNIT_S =='M262Bo' |
MAP_UNIT_S =='M262Bi' | MAP_UNIT_S =='M262Bm' | MAP_UNIT_S == 'M262Bl' | MAP_UNIT_S =='M262Bc' | MAP_UNIT_S == 'M262Bp' | MAP_UNIT_S == 'M262Ba' | MAP_UNIT_S == 'M262Bb')
usfs.socal.union <- usfs.socal %>% st_union()
#Landsat dNDMI
dndmi.2004 <- raster(file.path(socal_dir, 'dNDMI_2004_bigger_region_300m_v4.tif'))
crs(dndmi.2004) <- c
dndmi.2004.m <- is.na(dndmi.2004) #is this actually a good way to mask this?
dndmi.2004.mask <- mask(dndmi.2004, mask = dndmi.2004.m, maskvalue = 1)
dndmi.2017 <- raster(file.path(socal_dir, 'dNDMI_2017_bigger_region_300m_v4.tif'))
crs(dndmi.2017) <- c
dndmi.2017.m <- is.na(dndmi.2017)
dndmi.2017.mask <- mask(dndmi.2017, mask = dndmi.2017.m, maskvalue = 1)
#Landsat four-year Pr-ET
PrET.2002 <- raster(file.path(socal_dir, 'PrET_2002_bigger_region_300m_v4.tif'))
crs(PrET.2002) <- c
PrET.2002.m <- is.na(PrET.2002)
PrET.2002.mask <- mask(PrET.2002, mask = PrET.2002.m, maskvalue = 1)
PrET.2015 <- raster(file.path(socal_dir, 'PrET_2015_bigger_region_300m_v4.tif'))
crs(PrET.2015) <- c
PrET.2015.m <- is.na(PrET.2015)
PrET.2015.mask <- mask(PrET.2015, mask = PrET.2015.m, maskvalue = 1)
#Landsat Biomass
biomass.1999 <- raster(file.path(socal_dir, 'biomass_1999_bigger_region_300m.tif'))
crs(biomass.1999) <- c
biomass.1999.m <- is.na(biomass.1999)
biomass.1999.mask <- mask(biomass.1999, mask = biomass.1999.m, maskvalue = 1)
biomass.2012 <- raster(file.path(socal_dir, 'biomass_2012_bigger_region_300m.tif'))
crs(biomass.2012) <- c
biomass.2012.m <- is.na(biomass.2012)
biomass.2012.mask <- mask(biomass.2012, mask = biomass.2012.m, maskvalue = 1)
#Landsat tmax
tmax.2002 <- raster(file.path(socal_dir, 'tmax_2002_bigger_region_300m.tif'))
crs(tmax.2002 ) <- c
tmax.2002.m <- is.na(tmax.2002)
tmax.2002.mask <- mask(tmax.2002, mask = tmax.2002.m, maskvalue = 1)
tmax.2015 <- raster(file.path(socal_dir, 'tmax_2015_bigger_region_300m.tif'))
crs(tmax.2015) <- c
tmax.2015.m <- is.na(tmax.2015)
tmax.2015.mask <- mask(tmax.2015, mask = tmax.2015.m, maskvalue = 1)
#ADS Die-off
ads.2004 <- raster(file.path(socal_dir, 'ADS_2004_bigger_region_300m.tif'))
crs(ads.2004) <- c
ads.2004.reclass <- reclassify(ads.2004, c(-Inf,8,0,8,Inf,1), right = FALSE)
ads.2004.m <- is.na(ads.2004.reclass) #is this actually a good way to mask this?
ads.2004.mask <- mask(ads.2004.reclass, mask = ads.2004.m, maskvalue = 1)
ads.2017 <- raster(file.path(socal_dir, 'ADS_2017_bigger_region_300m.tif'))
crs(ads.2017) <- c
ads.2017.reclass <- reclassify(ads.2017, c(-Inf,8,0,8,Inf,1), right = FALSE)
ads.2017.m <- is.na(ads.2017.reclass)
ads.2017.mask <- mask(ads.2017.reclass, mask = ads.2017.m, maskvalue = 1)
p11 <- ggplot() +
ggR(img = base.ca.mask, layer = 1, maxpixels = 1e12, geom_raster = FALSE, ggLayer = TRUE, forceCat = TRUE, sat = 0.0, hue = 0.4, alpha = 1.0) +
geom_sf(data = ca_20m_crop, color='black', size = 0.2, fill=NA) +
ggR(img = ads.2004.mask, layer = 1, maxpixels = 1e10, geom_raster = TRUE, ggLayer = TRUE, forceCat = TRUE) + #Less Strict Drougth Mask Pixels, Error when only this is present.
geom_sf(data = usfs.sierra.union, color='black', size = 0.3, fill='black', alpha = 0) +
geom_sf(data = usfs.socal.union, color='black', size = 0.3, fill='black', alpha = 0) +
coord_sf() + guides(fill = FALSE) + xlab(NULL) + ylab(NULL) + #xlab('Longitude') + ylab('Latitude') +
annotation_scale(location = "bl", height = unit(0.1, "cm"), width_hint = 0.2) +
annotation_north_arrow(location = "bl", which_north = "true",
height = unit(1, "cm"), width = unit(1, "cm"),
pad_x = unit(0.1, "cm"), pad_y = unit(0.5, "cm"),
style = north_arrow_minimal) +
#The plot.margin order is top, right, bottom, left
theme_bw() + theme(axis.title.y = element_text(size=10), axis.text.y = element_text(size=8), axis.title.x = element_text(size=10), axis.text.x = element_text(size=8)) +
scale_fill_manual(values = c("1" = "#D41159","0" = "lightyellow1"), name = 'ADS', labels = c("No Mortality", "Mortality"), na.value = NA, na.translate = F) +
#guides( fill = guide_legend(title.position = "top")) +
ggtitle("1999-2002")
#Die-off (ADS) 2012-2015 drought
p12 <- ggplot() +
ggR(img = base.ca.mask, layer = 1, maxpixels = 1e12, geom_raster = FALSE, ggLayer = TRUE, forceCat = TRUE, sat = 0.0, hue = 0.4, alpha = 1.0)+
geom_sf(data = ca_20m_crop, color='black', size = 0.2, fill=NA) +
ggR(img = ads.2017.mask, layer = 1, maxpixels = 1e10, geom_raster = TRUE, ggLayer = TRUE, forceCat = TRUE) + #Less Strict Drougth Mask Pixels, Error when only this is present.
geom_sf(data = usfs.sierra.union, color='black', size = 0.3, fill='black', alpha = 0) +
geom_sf(data = usfs.socal.union, color='black', size = 0.3, fill='black', alpha = 0) +
coord_sf() + xlab(NULL) + ylab(NULL) + #xlab('Longitude') + ylab('Latitude') +
# guides(fill = guide_colorbar(barwidth = 5, barheight = 1, title.position = "top", title.hjust = 0.5, ticks.colour = "black")) +
guides(fill = guide_legend(title.hjust = 0.5, title.position = "top")) +
theme_bw() + theme(axis.title.y = element_text(size=10), axis.text.y = element_text(size=8), axis.title.x = element_text(size=10),
legend.background = element_rect(colour = NA, fill = NA),
axis.text.x = element_text(size=8), legend.justification = c(1, 0), legend.position = c(0.37, 0.01),
legend.text = element_text(size = 6), legend.title = element_text(size = 7), legend.direction = "vertical") +
scale_fill_manual(values = c("1" = "#D41159","0" = "lightyellow1"), name = 'Die-off (ADS)', labels = c("No Mortality", "Mortality"), na.value = NA, na.translate = F) +
ggtitle("2012-2015")
# p12
f6 <- ggarrange(p11, p12, ncol = 2, nrow = 1, common.legend = FALSE, labels = c('a', 'b'))
# f6
drought.region.both <- raster(file.path(socal_dir, 'Drought_both_bigger_region_300m_v5.tif'))
drought.region.both.calc <- drought.region.both * 2
crs(drought.region.both.calc) <- c
drought.region.second <- raster(file.path(socal_dir, 'Drought_second_bigger_region_300m_v5.tif'))
crs(drought.region.second) <- c
drought.region.all <- drought.region.both.calc + drought.region.second
drought.region.all.m <- drought.region.all == 0
drought.region.all.mask <- mask(drought.region.all, mask = drought.region.all.m, maskvalue = 1)
#Create Southern California region polygon
socal.ext <- as(extent(-120.5, -115.5, 32.2, 38.9), 'SpatialPolygons')
crs(socal.ext) <- wg
socal.ext <- spTransform(socal.ext, c)
#Import hillshade base map for California
base.ca <- raster(file.path(dir_usgs, 'hillshade_bigger_region_300m_v2.tif'))
crs(base.ca) <- c
base.ca.m <- base.ca == 0
base.ca.mask <- mask(base.ca, mask = base.ca.m, maskvalue = 1)
#Add California Boundary shape file
us_states_20m <- states(cb = TRUE, resolution = "20m", class = "sf")
us_states_20m <- st_transform(us_states_20m, c)
ca_20m <- us_states_20m[us_states_20m$NAME == "California", ]
ca_20m_crop <- st_crop(ca_20m, socal.ext)
p11 <- ggplot() +
ggR(img = base.ca.mask, layer = 1, maxpixels = 1e12, geom_raster = FALSE, ggLayer = TRUE, forceCat = TRUE, sat = 0.0, hue = 0.4, alpha = 1.0) +
geom_sf(data = ca_20m_crop, color='black', size = 0.2, fill=NA) +
ggR(img = ads.2004.mask, layer = 1, maxpixels = 1e10, geom_raster = TRUE, ggLayer = TRUE, forceCat = TRUE) + #Less Strict Drougth Mask Pixels, Error when only this is present.
geom_sf(data = usfs.sierra.union, color='black', size = 0.3, fill='black', alpha = 0) +
geom_sf(data = usfs.socal.union, color='black', size = 0.3, fill='black', alpha = 0) +
coord_sf() + guides(fill = FALSE) + xlab(NULL) + ylab(NULL) + #xlab('Longitude') + ylab('Latitude') +
annotation_scale(location = "bl", height = unit(0.1, "cm"), width_hint = 0.2) +
annotation_north_arrow(location = "bl", which_north = "true",
height = unit(1, "cm"), width = unit(1, "cm"),
pad_x = unit(0.1, "cm"), pad_y = unit(0.5, "cm"),
style = north_arrow_minimal) +
#The plot.margin order is top, right, bottom, left
theme_bw() + theme(axis.title.y = element_text(size=10), axis.text.y = element_text(size=8), axis.title.x = element_text(size=10), axis.text.x = element_text(size=8)) +
scale_fill_manual(values = c("1" = "#D41159","0" = "lightyellow1"), name = 'ADS', labels = c("No Mortality", "Mortality"), na.value = NA, na.translate = F) +
#guides( fill = guide_legend(title.position = "top")) +
ggtitle("1999-2002")
#Die-off (ADS) 2012-2015 drought
p12 <- ggplot() +
ggR(img = base.ca.mask, layer = 1, maxpixels = 1e12, geom_raster = FALSE, ggLayer = TRUE, forceCat = TRUE, sat = 0.0, hue = 0.4, alpha = 1.0)+
geom_sf(data = ca_20m_crop, color='black', size = 0.2, fill=NA) +
ggR(img = ads.2017.mask, layer = 1, maxpixels = 1e10, geom_raster = TRUE, ggLayer = TRUE, forceCat = TRUE) + #Less Strict Drougth Mask Pixels, Error when only this is present.
geom_sf(data = usfs.sierra.union, color='black', size = 0.3, fill='black', alpha = 0) +
geom_sf(data = usfs.socal.union, color='black', size = 0.3, fill='black', alpha = 0) +
coord_sf() + xlab(NULL) + ylab(NULL) + #xlab('Longitude') + ylab('Latitude') +
# guides(fill = guide_colorbar(barwidth = 5, barheight = 1, title.position = "top", title.hjust = 0.5, ticks.colour = "black")) +
guides(fill = guide_legend(title.hjust = 0.5, title.position = "top")) +
theme_bw() + theme(axis.title.y = element_text(size=10), axis.text.y = element_text(size=8), axis.title.x = element_text(size=10),
legend.background = element_rect(colour = NA, fill = NA),
axis.text.x = element_text(size=8), legend.justification = c(1, 0), legend.position = c(0.37, 0.01),
legend.text = element_text(size = 6), legend.title = element_text(size = 7), legend.direction = "vertical") +
scale_fill_manual(values = c("1" = "#D41159","0" = "lightyellow1"), name = 'Die-off (ADS)', labels = c("No Mortality", "Mortality"), na.value = NA, na.translate = F) +
ggtitle("2012-2015")
# p12
f6 <- ggarrange(p11, p12, ncol = 2, nrow = 1, common.legend = FALSE, labels = c('a', 'b'))
# f6
ggsave(filename = 'SupFig12_ADS_Maps.png', height=12.5, width= 16, units = 'cm', dpi=900)
